name: Deploy to production

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
            --build-arg POSTGRES_USER="${{ vars.POSTGRES_USER }}" \
            --build-arg POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            --build-arg POSTGRES_DB="${{ vars.POSTGRES_DB }}" \
            -f docker/production/Dockerfile \
            -t app .

      - name: Save Docker image
        run: docker save app | gzip > app.tar.gz

      - name: Copy image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "app.tar.gz"
          target: "/tmp"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            cd ~/app

            echo "Creating .env file..."

            cat > .env <<EOF
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=https://hello-world.website
            NEXTAUTH_URL=https://hello-world.website
            POSTGRES_USER=${{ vars.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ vars.POSTGRES_DB }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            CLIENT_ID_GITHUB=${{ secrets.CLIENT_ID_GITHUB }}
            CLIENT_SECRET_GITHUB=${{ secrets.CLIENT_SECRET_GITHUB }}
            CLIENT_ID_GOOGLE=${{ secrets.CLIENT_ID_GOOGLE }}
            CLIENT_SECRET_GOOGLE=${{ secrets.CLIENT_SECRET_GOOGLE }}
            EOF

            echo "Loading image..."
            docker load < /tmp/app.tar.gz

            echo "Starting database..."
            docker compose -f ./docker/production/compose.yaml up -d db

            echo "Running migrations..."
            docker compose -f ./docker/production/compose.yaml run --rm app-production npm run migration:run

            echo "Starting application..."
            docker compose -f ./docker/production/compose.yaml up -d
